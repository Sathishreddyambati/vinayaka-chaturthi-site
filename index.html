<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMR Vinayaka Funds</title>
  <style>
    /* [Previous CSS remains exactly the same] */
  </style>
</head>
<body>

  <!-- [Previous HTML structure remains exactly the same] -->

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Debugging flag
    const DEBUG = true;
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDKMySTY1e7iTHziERxxNk8PJh_0BxRuX8",
      authDomain: "donars-listmain.firebaseapp.com",
      databaseURL: "https://donars-listmain-default-rtdb.firebaseio.com",
      projectId: "donars-listmain",
      storageBucket: "donars-listmain.appspot.com",
      messagingSenderId: "161394187809",
      appId: "1:161394187809:web:12a18ba01dd84734ab4d60",
      measurementId: "G-RGHMRS5XWD"
    };

    try {
      // Initialize Firebase
      if (DEBUG) console.log("Initializing Firebase...");
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      
      // Database references
      const donorsRef = database.ref('donors');
      const expensesRef = database.ref('expenses');
      const adminRef = database.ref('admin');

      // Local data storage
      let donors = [];
      let expenses = [];
      let ADMIN_PASSWORD = "admin123"; // Default password

      // Wait for DOM to load
      document.addEventListener('DOMContentLoaded', function() {
        if (DEBUG) console.log("DOM fully loaded");
        
        // Get password from Firebase
        adminRef.child('password').once('value').then((snapshot) => {
          if (snapshot.exists()) {
            ADMIN_PASSWORD = snapshot.val();
            if (DEBUG) console.log("Admin password set to:", ADMIN_PASSWORD);
          }
          
          // Set up event listeners AFTER password is loaded
          setupEventListeners();
          
          // Set up real-time data listeners
          setupDataListeners();
          
        }).catch(error => {
          console.error("Error loading admin password:", error);
          // Continue with default password if there's an error
          setupEventListeners();
          setupDataListeners();
        });
      });

      function setupEventListeners() {
        if (DEBUG) console.log("Setting up event listeners...");
        
        // Login button
        document.getElementById('loginBtn').addEventListener('click', function() {
          const password = document.getElementById("adminPassword").value;
          const errorElement = document.getElementById("loginError");
          
          if (!password) {
            errorElement.textContent = "Please enter a password";
            return;
          }
          
          if (password === ADMIN_PASSWORD) {
            document.body.classList.add("logged-in");
            document.getElementById("loginForm").style.display = "none";
            errorElement.textContent = "";
            if (DEBUG) console.log("Login successful");
          } else {
            errorElement.textContent = "Incorrect password!";
          }
        });

        // Add Donor button
        document.getElementById('addDonorBtn').addEventListener('click', function() {
          const name = document.getElementById("donorName").value.trim();
          const amount = parseInt(document.getElementById("donationAmount").value);
          const errorElement = document.getElementById("donorError");
          const successElement = document.getElementById("donorSuccess");
          
          // Validation
          if (!name) {
            errorElement.textContent = "Please enter donor name";
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            errorElement.textContent = "Please enter a valid amount";
            return;
          }
          
          // Add to Firebase
          donorsRef.push({
            name: name,
            amount: amount,
            timestamp: Date.now()
          }).then(() => {
            document.getElementById("donorName").value = "";
            document.getElementById("donationAmount").value = "";
            successElement.textContent = "Donor added successfully!";
            setTimeout(() => successElement.textContent = "", 3000);
          }).catch(error => {
            errorElement.textContent = "Error adding donor: " + error.message;
          });
        });

        // Add Expense button
        document.getElementById('addExpenseBtn').addEventListener('click', function() {
          const name = document.getElementById("expenseName").value.trim();
          const amount = parseInt(document.getElementById("expenseAmount").value);
          const errorElement = document.getElementById("expenseError");
          const successElement = document.getElementById("expenseSuccess");
          
          // Validation
          if (!name) {
            errorElement.textContent = "Please enter expense description";
            return;
          }
          if (isNaN(amount) || amount <= 0) {
            errorElement.textContent = "Please enter a valid amount";
            return;
          }
          
          // Add to Firebase
          expensesRef.push({
            name: name,
            amount: amount,
            timestamp: Date.now()
          }).then(() => {
            document.getElementById("expenseName").value = "";
            document.getElementById("expenseAmount").value = "";
            successElement.textContent = "Expense added successfully!";
            setTimeout(() => successElement.textContent = "", 3000);
          }).catch(error => {
            errorElement.textContent = "Error adding expense: " + error.message;
          });
        });
      }

      function setupDataListeners() {
        if (DEBUG) console.log("Setting up data listeners...");
        
        // Donors listener
        donorsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          donors = data ? Object.entries(data).map(([key, value]) => ({ id: key, ...value })) : [];
          updateDisplay();
        });

        // Expenses listener
        expensesRef.on('value', (snapshot) => {
          const data = snapshot.val();
          expenses = data ? Object.entries(data).map(([key, value]) => ({ id: key, ...value })) : [];
          updateDisplay();
        });
      }

      function updateDisplay() {
        updateDonorList();
        updateExpenseList();
        updateTotals();
        setupDynamicButtonListeners();
      }

      function updateDonorList() {
        let donorHTML = "";
        donors.forEach((donor) => {
          donorHTML += `
            <div class="item" data-id="${donor.id}">
              <span>${donor.name}: ₹${donor.amount}</span>
              <div>
                <button class="edit-btn admin-controls">Edit</button>
                <button class="delete-btn admin-controls">Delete</button>
              </div>
            </div>`;
        });
        document.getElementById("donorList").innerHTML = donorHTML || "<span class='loading'>No donors yet</span>";
      }

      function updateExpenseList() {
        let expenseHTML = "";
        expenses.forEach((expense) => {
          expenseHTML += `
            <div class="item" data-id="${expense.id}">
              <span>${expense.name}: ₹${expense.amount}</span>
              <div>
                <button class="edit-btn admin-controls">Edit</button>
                <button class="delete-btn admin-controls">Delete</button>
              </div>
            </div>`;
        });
        document.getElementById("expenseList").innerHTML = expenseHTML || "<span class='loading'>No expenses yet</span>";
      }

      function updateTotals() {
        const totalDonations = donors.reduce((sum, donor) => sum + (donor.amount || 0), 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
        
        document.getElementById("totalDonations").textContent = totalDonations;
        document.getElementById("totalExpenses").textContent = totalExpenses;
        document.getElementById("remaining").textContent = totalDonations - totalExpenses;
      }

      function setupDynamicButtonListeners() {
        // Edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.onclick = function(e) {
            const itemId = this.closest('.item').dataset.id;
            const isDonor = this.closest('#donorList');
            const item = isDonor 
              ? donors.find(d => d.id === itemId)
              : expenses.find(e => e.id === itemId);
            
            if (!item) return;
            
            const newName = prompt("Edit Name", item.name);
            if (newName === null) return;
            
            const newAmount = prompt("Edit Amount", item.amount);
            if (newAmount === null) return;
            
            if (newName && newAmount && !isNaN(newAmount)) {
              const ref = isDonor ? donorsRef : expensesRef;
              ref.child(itemId).update({
                name: newName.trim(),
                amount: parseInt(newAmount),
                timestamp: Date.now()
              });
            }
          };
        });

        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = function(e) {
            const itemId = this.closest('.item').dataset.id;
            const isDonor = this.closest('#donorList');
            const item = isDonor 
              ? donors.find(d => d.id === itemId)
              : expenses.find(e => e.id === itemId);
            
            if (!item) return;
            
            if (confirm(`Are you sure you want to delete ${isDonor ? 'donor' : 'expense'} ${item.name}?`)) {
              const ref = isDonor ? donorsRef : expensesRef;
              ref.child(itemId).remove();
            }
          };
        });
      }

    } catch (error) {
      console.error("Firebase initialization error:", error);
      alert("Application error. Please check console for details.");
    }
  </script>
</body>
</html>
